using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Numerics;
using System.Text;
using System.Text.RegularExpressions;
using Xunit;
using Xunit.Abstractions;
using static AdventOfCode2018.Util;

namespace AdventOfCode2018
{
    public class Day13
    {
        private readonly ITestOutputHelper output;

        public Day13(ITestOutputHelper output)
        {
            this.output = output;
        }

        public const string testInput = @"
/->-\        
|   |  /----\
| /-+--+-\  |
| | |  | v  |
\-+-/  \-+--/
  \------/   
";

        public const string testInput2 = @"
/>-<\  
|   |  
| /<+-\
| | | v
\>+</ |
  |   ^
  \<->/
";

        public const string puzzleInput = @"
                    /--------------------------------------------------\                                        /----------------\                    
          /---------+--------------------------------------------------+-------------\                          |                |/-------------\     
          |   /-----+---------------------------------\                |          /--+--------------------------+-------\        ||             |     
          |   |     |                                 |        /-------+----------+--+--------------------------+-------+---\    ||             |     
          |   |     |              /------------------+--------+-------+\         |  |                          |       |   |    ||             |     
          |   |     |    /---------+------------------+--------+--\    ||         |  |                    /-----+-------+---+----++-------------+---\ 
          |   |     |    |         |                  |        |  |    ||         |  |                    |     |       |   |    ||             |   | 
        /-+---+-----+----+---\     |                  |        |  |    ||         |/-+--------------------+-----+-------+---+----++-------------+\  | 
        | |   |     |    |   |     |   /--------------+--------+--+----++---------++-+--------------------+-----+------\|   |    ||             ||  | 
        | |/--+-----+----+---+-----+---+--------------+--------+--+----++\        || |                    |     |      ||   |    ||             ||  | 
        | ||  |     |    |   |     |   |              |        |  |   /+++--------++-+--------------------+\    |      ||   |    ||             ||  | 
        | ||  |   /-+----+---+-----+---+--------------+--\     |  |   ||||        || |  /-----------------++\   |      ||   |    ||             ||  | 
        | || /+---+-+--\ |   |     |   |              |  |     |  |   ||||        || |  |                 |||   |      ||   |    ||             ||  | 
      /-+-++-++---+-+--+-+---+-----+---+--------------+--+-----+--+---++++--------++-+--+----------\      |||   |      ||   |    ||             ||  | 
      | | || ||   | |  | |   |     |/--+--------------+\ |     |  |   ||||        || |  |          |      |||   |      ||   |    |\-------------/|  | 
      | | || ||   | |  | |   |/----++--+--------------++-+-----+--+---++++--------++-+--+----------+---\  |||   |      ||   |    |               |  | 
      | | || ||  /+-+--+-+---++----++--+--------------++-+-----+--+---++++--------++-+--+----------+---+--+++\  |      ||   |    |               |  | 
      | | || ||  || |  | |   ||    ||  |       /------++-+-----+--+---++++--------++-+--+----------+---+--++++--+---\  ||   |    |               |  | 
      | | || ||  || |  | |   ||    ||  |       |      || |     |  |   ||||        || |  |          |   |  ||||  |   |  ||   |    |               |  | 
      | | || ||  || |  | |   ||    || /+-------+------++-+-----+--+---++++---->---++-+--+----------+---+--++++--+---+--++---+-\  |               |  | 
      | | || ||  || |  | |   ||    || ||       |      || |     |  |   ||||        || |  |          |   |  ||||  |   |  ||   | |  |               |  | 
      | | || ||  || |  | |   ||    || ||       |      || |     |  |   ||||        || |  |          |   |  ||||  |   |  ||   | |  |               |  | 
      | | ||/++--++-+--+-+---++\   || ||       |      || |     |  |   ||||        || |  |          |   |  ||||  |   |  ||   | |  |               |  | 
     /+-+-+++++\ || |  | |   |||   || ||       |      || |/----+--+---++++--------++-+--+----------+---+--++++--+---+--++---+-+-\|               |  | 
 /---++-+-++++++-++-+--+-+---+++---++-++----->-+------++-++----+--+---++++--------++\|  |    /-----+---+--++++--+---+--++---+-+-++---------------+\ | 
 |   || | |||||| || \--+-+---+++---++-++-------+------++-++----+--+---+/||        |\++--+----+-----+---+--++++--+---+--++---+-+-++---------------/| | 
 |   || | |||||| ||    | |   |||   || ||     /-+------++-++----+--+---+-++--------+-++--+----+-----+---+--++++--+---+--++--\|/+-++------------\   | | 
 |   || | |||||| ||    | |   |||   || ||     | |  /---++-++----+-\|  /+-++--------+-++--+----+-----+-\ |  ||||  |   |  ||  |||| ||            |   | | 
 |   || | |||||| ||    | |   |||   || ||     | |  |   || ||   /+-++--++-++--\     | ||/-+----+-----+-+-+--++++--+---+--++--++++-++--\         |   | | 
 |   |\-+-++++++-++----+-+---+++---++-++-----+-+--+---++-++---++-++--++-++--+-----+-+++-+----+-----/ | |  ||||  |   |  ||  |||| ||  |         |   | | 
 |   |  | |||||| ||    | |   |||   || ||     | |  |   || ||   || ||  || ||  |     | ||| |    |       | |  ||||  |   | /++--++++-++--+--------\|   | | 
 |   |  | |||||| ||    | |   |||   || ||  /--+-+--+---++-++---++-++--++-++--+-----+-+++-+----+--\    | |  ||||  |   | |||  |||| ||  |        ||   | | 
 |   |  | |\++++-++----+-+---+++---++-++--+--+-+--+---++-++---++-++--++-+/  |     | ||| |  /-+--+----+-+--++++--+---+-+++--++++-++--+----\   ||   | | 
 |   |  | \-++++-++----+-+---+++---++-++--+--+-+--+---++-++---++-++--++-+---+-----+-+/| |  | |  |/---+-+--++++--+---+-+++--++++-++-\|    |   ||   | | 
 |   |  |   |||| \+----+-+---+++---++-++--+--+-+--+---++-++---++-++--++-+---+-----+-+-+-+--+-+--++---+-+--+++/  |   | |||  |||| || ||    |   ||   | | 
 |   |  |   ||||  |    | |   |||   || ||  |  | |  |   || ||   || ||  || |   |     | | | |  | |  ||   | |  |||   |   | |||  |||| || ||    |   ||   | | 
 |   |  |   ||||  |    | |   |||  /++-++--+--+-+--+---++-++---++-++--++-+---+----\| | | |  | |  ||   | |  |||   |   | |||  |||| || ||    |   ||   | | 
 |   |  \---++++--+----+-+---/||  ||| ||  |  | |  |   || ||  /++-++--++-+\  |    || | | |  | |  ||   | |  |||   |   | |||/-++++-++-++----+---++---+-+\
 |   |      ||||  |    | |    ||  ||| ||  |  | |  |   || ||  ||| ||  || ||  |    || | | |  | |  ||   | | /+++---+---+\|||| |||| || ||    |   ||   | ||
 |   |      ||||  |   /+-+----++--+++-++--+--+-+--+---++-++\ ||| ||  || ||  | /--++-+-+-+-\|/+--++---+-+-++++---+---++++++-++++-++-++----+---++--\| ||
 |   \------+++/  |   || |    ||  ||| ||/-+--+-+--+---++-+++-+++-++--++-++--+-+--++-+-+-+-++++--++---+-+-++++-\ |   |||||| |||| || ||    |   ||  || ||
 |          |||   |   || |    ||  ||| ||| |  | |  |   || |||/+++-++--++-++--+-+--++-+-+-+-++++->++---+-+-++++-+-+---++++++-++++-++-++--\ |   ||  || ||
 |          |||   |   || |    ||  ||| ||| \--+-+--+---++-+++++++-++--++-++--+-+--++-+-+-+-++++--/|   | | |||| | |   |||||| |||| || ||  | |   ||  || ||
 |          |||  /+---++-+----++--+++-+++----+-+--+---++-+++++++-++--++-++--+-+--++-+-+-+-++++--\|   | | |||| | |   |||||| |||| || ||  | |   ||  || ||
 |          |||  ||   || |    ||  ||| |||    | |  \---++-+++++++-/|  || ||  | |  || | | | |\++--++---+-+-++++-+-+---++++++-++++-++-++--+-/   ||  || ||
 |          |||  ||   || |    ||  ||v |||    | |      || |||||||  |  || ||  | |  || | | |/+-++--++---+-+-++++-+-+---++++++-++++-++-++-\|     ||  || ||
 |          |||/-++---++-+----++--+++-+++----+-+------++-+++++++--+--++-++--+-+--++-+-+-+++-++--++---+-+-++++-+-+--\|||||| ||||/++-++-++-\   ||  || ||
 |          |||| ||   || |   /++--+++-+++----+-+------++-+++++++-\|  \+-++--+-+--++-+-+-+++-++--++---/ | |||| | |  ||||||| ||||||| || || |   ||  || ||
 |          |||| ||   || |   |||  ||| \++----+-+------++-+++++++-++---+-++--+-+--++-+-+-+++-++--++-----+-++++-+-+--+++++++-+++/||| || || |   ||  || ||
 |          |||| ||   || |   |||  |||  ||    | |      || ||||||| ||   | ||  | |  || | | ||| ||  ||     | |||| | |  ||||||| ||| ||| || || |   ||  || ||
 |          |||| || /-++-+---+++--+++--++----+-+------++-+++++++-++---+-++--+-+--++-+-+-+++-++--++-----+-++++-+-+-\||||||| ||| ||| || || |   ||  || ||
 |          |||| || | || |   |||  |||  ||    |/+------++-+++++++-++---+-++--+\|  || | | ||| ||/-++-----+-++++-+-+-++++++++-+++-+++\|| || |   ||  || ||
 |  /-------++++-++-+-++-+---+++--+++--++----+++------++-+++++++-++-\ | ||  |||  || | | ||| ||| ||     | |||| | | |||||||| ||| |||||| || |   ||  || ||
 |  |       |||| || | || |   |||  |||  ||    |||      || ||||||| || | | ||  |||  || | | ||| ||| ||     | |||| | | |||||||| ||| |||||| || |   ||  || ||
 |  |       |||| || | || |   |||  |||  ||    |||      || ||||||| || | | ||  |||  || | | ||| ||| ||     | |||| | |/++++++++-+++-++++++-++-+-\ ||  || ||
 |  |       |||| || | || |   |||  |||  ||    |||      || ||||||| || | ^ ||  |||  || | | ||| ||| ||     | |||| | |||||||||| ||| |||||| || | | ||  || ||
 |  |       |||| || | ||/+---+++--+++--++----+++\     || ||||||| || | | ||  |||  || | | |^| ||| |\-----+-++++-+-++++++++++-+++-++++/| || | | ||  || ||
 |  |       |||| || | ||||   |||  ||\--++----++++-----+/ ||||||| || | | ||  |||  || | | ||| ||| |      | |||| | |||||||||| ||| |||| | || | | ||  || ||
 |  |  /----++++-++-+-++++---+++--++---++----++++-----+--+++++++-++-+-+-++--+++\ || | | ||| ||| |      | |||| | |||||||||\-+++-++++-+-++-+-+-++--++-+/
 |  |  |    |||| || | ||||   |||  ||   ||    ||||     |  ||||||| || | | ||  |||| || | \-+++-+++-+------+-++++-+-+++++++++--+++-++++-/ || | | ||  || | 
 |  |  |    |||| || | ||||   |||  ||   ||    ||||     |  ||||||| || |/+-++--++++-++-+---+++-+++-+------+-++++-+-+++++++++--+++\||||   || | | ||  || | 
 |  |  |    |||| |\-+-++++---+++--++---++----++++-----+--/|||||| || ||| ||  |||| || |   ||| ||| |      | |||| | |||||||||  |^||||||   || | | ||  || | 
 |  |  |    |||| |  | ||||   |||/-++---++----++++-----+---++++++-++-+++-++--++++-++-+---+++-+++-+----\ | |||| | |||||||||  ||||||||   || | | ||  || | 
 |  |  |    |||| |  | ||||   |||| ||   ||    ||||     |   |||||| || ||| ||  |||| || |   ||| \++-+----+-+-++++-+-+++++++++--++++++++---++-+-+-++--/| | 
 |  |  |  /-++++-+--+-++++---++++-++---++----++++-----+---++++++-++-+++-++-\|||| || |   |||  || |    | | |||| | |||||||||  ||||||||   || | | ||   | | 
 |  |  |  | |||| |  | ||||   |||| ||   ||    ||||     |   |||||| || ||| || ||||| || |   |||  || |    | | |||| | \++++++++--++++++/|   || | | ||   | | 
 |  |  |  | |||| |  | ||||   |||| ||   ||    ||||     |  /++++++-++-+++-++-+++++-++-+---+++--++\|    | | |||| |  ||||||||  |||||| |   || | | ||   | | 
 |  |  |  | |||| |  | ||||   |||| ||   ||    ||||     |  |||||||/++-+++-++-+++++-++-+---+++--++++----+-+\|||| |  ||||||||  |||||| |   || | | ||   | | 
 |  |  | /+-++++-+--+-++++---++++-++---++----++++-----+--++++++++++-+++-++-+++++-++-+-\ |||  ||||    | |||||| |  ||||||||  |||||| |   || | | ||   | | 
 |  |  | || |||| |  | ||||   |||| ||   \+----++++-----+--++++++++++-+++-++-+++++-++-+-+-+++--++++----+-++++++-+--++++++/|  |||||| |   || | | ||   | | 
 |  |  | || |\++-+--+-+/||   |||| ||    |    ||||     |  |||||||||| ||\-++-+++++-++-+-+-+++--++++----+-++++/| |  |||||| |  |||||| |   || | | ||   | | 
 |  |  | || | || |  | | ||   |||| ||    |    ||||     |  |||||\++++-++--++-+/||| || | |/+++--++++----+-++++-+-+--++++++-+--++++++-+-\ || | | ||   | | 
 |/-+--+-++-+-++-+--+-+\||   |||| ||    |    ||||     |  ||||| |||| ||  || | ||| || | |||||  ||||    | |||\-+-+--++++++-+--++++++-+-+-++-+-+-++---+-/ 
 || |  | || | || |  | ||||   |||| ||    |    ||||     |  ||||| |||| ||  || | ||| || | |||||  ||||    | |||/-+-+--++++++-+--++++++-+-+-++-+\| ||   |   
 || |  | || | || |  | ||||   |||| ||    | /--++++-----+--+++++-++++-++--++-+-+++-++-+-+++++--++++----+-++++-+-+--++++++-+--++++++-+-+-++-+++-++---+--\
 || |  | || | || |  | \+++---++++-++----+-+--++++-----+--++/|| |||| ||  || | |\+-++-+-++++/  ||||    | |||| | |  |||||| |  |||||| | | || ||| ||   |  |
 || |  | || | || |  |  |||   |||| ||    | |  ||||   /-+--++-++-++++-++--++-+-+-+-++-+-++++---++++----+-++++-+-+--++++++-+-\|||||| | | || ||| ||   |  |
 || |  | || \-++-+--+--+++---++/| ||    | |  ||||   | |  || || |||| ||  || | | | || | ||||  /++++----+-++++-+-+--++++++-+-+++++++-+-+-++\||| ||   |  |
 || |  | ||   || |  |  |||   || | |\----+-+--++++---+-+--++-++-++++-++--/| | | | ||/+-++++--+++++----+-++++-+-+--++++++-+-+++++++\| | |||||| ||   |  |
 || |  | ||   || |  |  |||   || | |     | |  ||||   | |  || || |||| ||   | | | | |||| ||||  |||||    | |||| | |  |||||| | ||||||||| | |||||| ||   |  |
 || |  | ||   || |  \--+++---++-+-+-----+-+--++++---+-+--++-++-++++-++---+-+-+-+-++++-++++--+++++----+-++++-+-+--+/|||| | ||||||||| | |||||| ||   |  |
 || |  | ||  /++-+-----+++\  || | \-----+-+--++++---+-+--++-++-++++-++---+-+-+-+-/||| ||||  |||||    | |||| | |  | |||| | ||||||||| | |||||| ||   |  |
 || |  | ||  |||/+-----++++--++-+----\  | |  ||||   | |  || || |||| ||   | | | |  ||| ||||  |||||    | |||| | |  | |||\-+-+++++++++-+-++++++-/|   |  |
 || |  | ||  ||\++-----++++--++-+----+--+-+--++++---+-+--++-++-++++-++---+-+-+-+--+++-++++--+++++----+-++++-+-+--+-/||  | ||||||||| | ||||||  |   |  |
 || |  ^ ||  || ||     |||| /++-+----+--+-+\ ||||   | |  || || |||| ||   | | | |  ||| ||||  ||\++----+-++++-+-+--+--++--+-++++++++/ | ||||||  |   |  |
 || |  | ||  || ||     |||| ||| |    |  | || ||||   \-+--++-++-++++-++---+-+-+-+--+++-++++--++-++----+-++++-+-+--+--++--+-/|||||||  | ||||||  |   |  |
 || |  | ||/-++-++-----++++\||| |    |  | || ||||     |  || || |||| |\---+-+-+-+--+++-++++--++-++----+-++++-+-+--+--++--+--+++/|||  | ||||||  |   |  |
 || |  | ||| |\-++-----++++++++-+----+<-+-++-++++-----/  || || |||| |    | | | |  ||| ||||  || ||    | ||\+-+-+--+--+/  |  ||| |||  | v|||||  |   |  |
 \+-+--+-+++-+--++-----++++++++-+----+--+-++-++++--------++-++-++++-+----+-+-+-+--++/ ||||  || ||/---+-++-+-+-+--+--+---+--+++-+++--+-++++++\ |   |  |
  | |  | ||| |  ||     |||||||| |    |  | || ||||        || || |||| |    | | | |  |\--++++--++-+++---+-++-+-+-+--+--+---+--+++-++/  | ||||||| |   |  |
  | | /+-+++-+--++-----++++++++-+----+--+-++-++++----\   || || \+++-+----+-+-+-+--+---++++--++-+++---+-++-+-+-+--+--+---+--+/| ||   | ||||||| |   |  |
  | | || |||/+--++-----++++++++-+----+--+-++\||||    |   || \+--+++-+----+-+-+-+--+---++++--++-+++---+-++-+-+-+--+--+---+--+-+-++---+-+/||||| |   |  |
/-+-+-++-+++++--++-----++++++++-+----+--+-+++++++----+---++-\|  \++-+----+-+-+-+--+---++++--++-+++---+-+/ | | |  |  |   |  | | ||   | | ||||| |   |  |
| | | || |||||  ||     |||||||| |    |  | |||||||    |   || ||   || |    | | | |  \---++++--++-+++---+-+--+-+-+--+--+---/  | | ||   | | ||||| |   |  |
| | | || |||||  ||     |||||||| |    |  | |||||||    |   || ||   ||/+----+-+-+-+------++++-\|\-+++---+-+--+-+-+--+--+------+-+-++---+-+-+++++-+---/  |
| | | || |||||  ||     |||||||| |    |  | |||||||/---+---++-++---++++----+-+-+-+------++++-++--+++---+-+--+-+-+--+--+------+-+-++->-+-+-+++++-+\     |
| | | || |||||  ||     |||||||| |    |  | ||||||||   |   || ||   ||||    |/+-+-+------++++-++--+++---+-+--+-+-+--+--+------+-+-++---+-+\||||| ||     |
| | | || |||||/-++-----++++++++-+----+--+-++++++++---+---++-++---++++-\  ||| |/+------++++-++--+++---+-+--+-+-+--+--+------+-+-++---+-+++++++-++----\|
| | | || |||||| ||     |||||||| |    |  | ||||||||   |   || ||   |||| |  ||| |||      |||| ||  |||   | |  | | |  |  |      | | ||   | ||||||| ||    ||
| | \-++-++++++-++-----++++++++-+----+--+-++++++++---+---++-++---+++/ |  ||| |||      |||| ||  |||   | |  | | |  |  |      | | ||   | ||||||| ||    ||
| |   || |||||| ||     |||||||\-+----+--+-++++++++---+---++-++---+++--+--+++-+++------++++-++--+++---+-/  | | |  |  |      | | ||   | ||||||| ||    ||
| |   || |||||| ||     |||||||  |    |  | \+++++++---+---++-++---+++--+--+++-+++------++++-++--+++---+----+-+-+--+--+------+-+-++---+-+++++++-++----+/
| |   || |||||| ||     |||||||  |    |  |  |||||||   |   || ||   |||  |  ||| |||      |||| ||  |||   |    | | |  |  |      | | ||   | ||||||| ||    | 
| |   || |||||| ||     |||||||  |    |  |  |||||||   |   || ||   |||  |  ||| ||| /----++++-++--+++---+----+-+-+--+--+------+-+-++--\| ||||||| ||    | 
| |   || |||||| ||     |||||||  |    |  |  |||\+++---+---++-++---+++--+--+++-/|| |    |||| ||  |||   |    | | |  |  |      | | ||  || ||||||| ||    | 
| |   || |||||| ||     |||||||  |    |  |  ||| |||   |   |\-++---+++--+--+++--++-+----++++-++--+++---+----+-+-+--+--+------+-+-+/  || ||||||| ||    | 
| |   || |||||| ||     |||||||  |    |  |  ||| |||   |   |  ||   |||  |  |||  || |    |||| ||  |||  /+----+-+-+--+--+------+-+-+--\|| ||||||| ||    | 
| |   || |||||| ||     |||||||  |    |  |  ||| |||   |   \--++---+++--+--+++--++-+----++++-++--/||  ||    | | |  |  |  /---+-+-+--+++-+++++++-++\   | 
| |   \+-++++++-++-----+++++++--+----+--+--+++-+++---/      ||   |||  |/-+++--++-+----++++-++---++-\||    | | |  |  |  |   | | \--+++-+++/||| |||   | 
| |    | |||||| ||     |||||||  |    |  |  ||| |||          ||   |||  || |||  || |    v||| ||   || |||   /+-+-+--+--+--+---+-+\   ||| ||| ||| |||   | 
| |    | |||||| ||     |||||||  |    |  \--+++-+++----------++---+++--++-+++--++-+----++++-++---++-+++---++-+-/  |  |  |   | ||   ||| ||| ||| |||   | 
| \----+-++++++-++-----/|\++++--+----+-----+++-+++----------++---+/|  || |||  || |    ||||/++---++-+++---++-+---\|  |  |   | ||   ||| ||| ||| |||   | 
|      | |||||| \+------+-++++--+----/     ||| |||          ||   | |  || |||  || |    |||||||   || |||   || |   ||  |  |   | ||   ||| ||| ||| |||   | 
|      | ||||||  |      | ||||  |          ||| |||          ||   | |  || |||  || |    |||||||   || |||   || |   ||  |  |   | ||   ||| ||| ||| |||   | 
|      | ||||||  |    /-+-++++--+------\   ||| ||v          ||   | |  || |||  || |    |||||||   |\-+++---++-+---++--+--+---+-++---+++-+++-++/ |||   | 
|      | ||||||  |    | | ||||  |      |   ||| |||          ||   | |  || |||  || |    ||\++++---+--+++---++-/   ||  |  |   | ||   ||| ||| ||  |||   | 
|      | ||||||  |    | | ||||  |      |   ||| |||          ||   | |  || |||  \+-+----++-++++---+--+++---++-----++--+--+---+-++---+++-+++-++--+++---/ 
|      \-++++++--+----+-+-++++--+------+---+++-+++----------++---+-+--++-+++---/ |    || ||||   |  |||   ||     ||  |  |   | ||   ||| ||| ||  |||     
|        ||||||  |    | | ||||  |      |   ||\-+++----------++---+-+--++-+++-----+----++-++++---+--+++---++-----++--+--+---/ \+---+++-+++-++--/||     
|     /--++++++--+----+-+-++++--+------+---++--+++\         |\---+-+--++-/||     |    || ||||   |  |||   \+-----++--+--+------/   ||| ||| ||   ||     
|     |  ||||||  |    | | ||||  |      |   ||  ||||         |    | |  ||  ||     |    || ||||   |  |||    |     ||  |  |          ||| ||| ||   ||     
|     |  \+++++--+----+-+-++++--+------+---++--++++---------+----+-+--++--++-----+----/| ||||   |  |||    \-----++--+--+----------+++-+++-/|   ||     
|     |/--+++++--+----+-+-++++--+------+---++-\\+++---------+----+-+--++--++-----+-----+-++++---+--+++----------++--/  |          ||| |||  |   ||     
|     ||  |||||  |    | | ||||  \------+---++-+-+++---------+----+-+--++--++-----+-----+-++++---+--++/          ||     |          ||| |||  |   ||     
|     ||  |||||  |    | | ||||         |   || | |||         |    | |  ||  ||     |     | ||||   |  ||           ||     |          ||| |||  |   ||     
|     ||  |||||  |    | | ||||         |   || | |||         |    | |  ||  ||     |     | ||||   |  ||/----------++-----+------\   ||| |||  |   ||     
|     ||  |||||  |    | | ||||         |   || | |||         |    | \--++--++-----+-----+-++/|   |  |||          ||     |      |   ||| |||  |   ||     
|/----++--+++++--+----+-+-++++---------+---++-+-+++---------+----+----++--++-----+\    | \+-+---+--+++----------++-----+------+---+++-/||  |   ||     
||    ||  |||||  |    \-+-++++---------/   || | |||         |    |    ||  ||     ||    |  | |   |  |||          ||     |      |   |||  ||  |   ||     
||    ||  |||||  |      | ||||             || | |||         |    |    ||  ||     ||    |  | |   |  |||          ||     \------+---+++--++--+---+/     
||    ||  |||||  |      | ||\+-------------/| | |||         |    |    ||  || /---++----+--+-+---+--+++---\      ||            |   |||  ||  |   |      
||    |\--+++++--+------+-++-+--------------+-/ |||         |    |    ||  || |   ||    |  | |   |  |||   |      ||            |   |||  ||  |   |      
||    |   |||||  |      | || |  /-----------+\  |\+---------+----+----++--++-+---++----+--+-+---+--+++---+------++------------+---+++--++--+---/      
||    |   |\+++--+------+-+/ |  |   /-------++--+-+--\      |    |    ||  || |   ||    |  | |   |  |||   |      ||            |   |||  ||  |          
||    |  /+-+++--+------+-+--+--+---+-------++--+-+--+------+----+----++--++-+---++----+--+-+---+--+++\  |      ||            |   |||  ||  |          
||    |  || |||  |      | |  |  |   |       ||  | |  |      |    |    ||  || |   ||    |  | |   |  ||\+--+------++------------/   |||  |^  |          
||    |  || |||  |      | |  \--+---+-------++--+-+--+------+----/    ||  || |   ||    |  | |   |  || |  |      ||                |||  ||  |          
||    |  || |||  |      | |     |   |       ||  | |  |      |         ||  || |   ||    |  | |   |  || |  |      ||                |||  ||  |          
||    \--++-+++--+------+-+-----+---+-------++--+-/  |      |         ||  || |   ||    \--+-+---+--++-+--+------++----------------++/  ||  |          
||       || |||  |      \-+-----+---+-------++--/    |      |         ||  || |   ||       | |   |  || |  |      |\----------------++---++->/          
||       || ||\--+--------+-----+---+-------++-------+------+-<-------/|  || |   ||       | \---+--++-+--+------+-----------------++---+/             
||       |\-++---+--------+-----+---+-------++-------+------+----------+--+/ |   ||       |     |  || |  |      |                 ||   |              
\+-------+--++>--+--------+-----+---+-------++-------+------/          |  |  \---++-------+-----+--++-+--/      |                 ||   |              
 |       |  ||   \--------+-----+---+-------++-------+-----------------+--+------++-------+-----/  || |         |                 ||   |              
 |       |  \+------------+-----+---+-------/|       |                 |  \------++-------+--------++-+---------+-----------------++---/              
 |       |   \------------/     \---+--------/       |                 |         \+-------+--------++-+---------+-----------------+/                  
 |       |                          |                |                 \----------+-------+--------/| |         |                 |                   
 \-------+--------------------------+----------------+----------------------------/       |         \-+---------+-----------------/                   
         \--------------------------+----------------+------------------------------------+-----------/         |                                     
                                    \----------------/                                    \---------------------/                                     
";

        [Fact] public void Solution_1_test_example() => Assert.Equal("7,3", Solve1(testInput));
        [Fact] public void Solution_1_test_real_input() => Assert.Equal("119,41", Solve1(puzzleInput));

        [Fact] public void Solution_2_test_example() => Assert.Equal("6,4", Solve2(testInput2));
        [Fact] public void Solution_2_test_real_input() => Assert.Equal("45,136", Solve2(puzzleInput));
        
        [Fact] public void Solution_2_test_example_fourway_collision() => Assert.Equal("6,4", Solve2(@"
/---\  
|   |  
| /<+-\
| v | |
\>+</ |
  ^   |
  \<->/
"));

        [Fact] public void Solution_2_test_example_near_miss() => Assert.Equal("2,4", Solve2(@"
/----\  
|  /<+-\
|  | | |
|  | | |
\->+-/ |
   |   |
   ^   |
   \---/
"));

        public class Cart
        {
            public int X { get; set; }
            public int Y { get; set; }
            public int NextTurn { get; set; } // 0-1-2 = left-straight-right
            public int Direction { get; set; } // 0-1-2-3 = up-right-down-left

            public override string ToString() => $"{GetHashCode()} on ({X},{Y}), direction {Direction}, turning {NextTurn}";
        }

        public string Solve1(string input) => RunUntilDone(input);

        public string Solve2(string input) => RunUntilDone(input, maxCollisions: int.MaxValue);

        private string RunUntilDone(string input, int maxCollisions = 1)
        {
            var (grid, carts) = ConstructFromInput(input);
            var collisionCount = 0;

            while (carts.Count() > 1)
            {
                foreach (var cart in carts.OrderBy(c => c.Y).ThenBy(c => c.X).ToList())
                {
                    if (!carts.Contains(cart)) continue; // Other cart collided with this one

                    if (cart.Direction == 0) cart.Y--;
                    if (cart.Direction == 1) cart.X++;
                    if (cart.Direction == 2) cart.Y++;
                    if (cart.Direction == 3) cart.X--;

                    var colliders = carts.Where(c => c != cart && c.X == cart.X && c.Y == cart.Y).ToHashSet();
                    if (colliders.Any())
                    {
                        if (++collisionCount >= maxCollisions) return $"{cart.X},{cart.Y}";
                        carts.RemoveWhere(c => colliders.Contains(c));
                        carts.Remove(cart);
                    }
                    else
                    {
                        if (grid[cart.X, cart.Y] == '+')
                        {
                            if (cart.NextTurn == 0) cart.Direction--;
                            if (cart.NextTurn == 1) ; // straight ahead!
                            if (cart.NextTurn == 2) cart.Direction++;

                            cart.NextTurn = (cart.NextTurn + 1) % 3;
                            cart.Direction = (cart.Direction + 4) % 4;
                        }

                             if (grid[cart.X, cart.Y] == '/' && cart.Direction == 0) cart.Direction = 1;
                        else if (grid[cart.X, cart.Y] == '/' && cart.Direction == 1) cart.Direction = 0;
                        else if (grid[cart.X, cart.Y] == '/' && cart.Direction == 2) cart.Direction = 3;
                        else if (grid[cart.X, cart.Y] == '/' && cart.Direction == 3) cart.Direction = 2;

                        else if (grid[cart.X, cart.Y] == '\\' && cart.Direction == 0) cart.Direction = 3;
                        else if (grid[cart.X, cart.Y] == '\\' && cart.Direction == 1) cart.Direction = 2;
                        else if (grid[cart.X, cart.Y] == '\\' && cart.Direction == 2) cart.Direction = 1;
                        else if (grid[cart.X, cart.Y] == '\\' && cart.Direction == 3) cart.Direction = 0;
                    }
                }
            }

            OutputGrid(grid, carts);

            return $"{carts.Single().X},{carts.Single().Y}";
        }

        private (char[,] Grid, HashSet<Cart> carts) ConstructFromInput(string input)
        {
            var data = input.SplitByNewline();
            int width = data.First().Length;
            int height = data.Count();
            var grid = new char[width, height];
            var carts = new HashSet<Cart>();

            for (int y = 0; y < height; y++)
            {
                for (int x = 0; x < width; x++)
                {
                    grid[x, y] = data[y][x];

                    if (grid[x, y] == '^') { carts.Add(new Cart { X = x, Y = y, Direction = 0 }); grid[x, y] = '|'; }
                    if (grid[x, y] == '>') { carts.Add(new Cart { X = x, Y = y, Direction = 1 }); grid[x, y] = '-'; }
                    if (grid[x, y] == 'v') { carts.Add(new Cart { X = x, Y = y, Direction = 2 }); grid[x, y] = '-'; }
                    if (grid[x, y] == '<') { carts.Add(new Cart { X = x, Y = y, Direction = 3 }); grid[x, y] = '|'; }
                    // Lucky (?) my input has no carts starting on intersections?
                }
            }

            return (grid, carts);
        }

        private void OutputGrid(char[,] grid, ISet<Cart> carts)
        {
            output.WriteLine("");
            for (int y = 0; y < grid.GetLength(1); y++)
            {
                var sb = new StringBuilder();
                for (int x = 0; x < grid.GetLength(0); x++)
                {
                    var cart = carts.FirstOrDefault(c => c.X == x && c.Y == y);
                    if (cart != null)
                    {
                        if (cart.Direction == 0) sb.Append('^');
                        if (cart.Direction == 1) sb.Append('>');
                        if (cart.Direction == 2) sb.Append('v');
                        if (cart.Direction == 3) sb.Append('<');
                    }
                    else
                    {
                        sb.Append(grid[x, y]);
                    }
                }
                output.WriteLine(sb.ToString());
            }
            output.WriteLine("");
        }
    }
}
